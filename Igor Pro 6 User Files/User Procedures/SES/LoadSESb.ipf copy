// File: LoadSESb		Created: 12/99, J. D. Denlinger// Adapted from LoadSESB#pragma rtGlobals=1		// Use modern global access method.#include "List_util"// SES-100 Binary File structure:  //  -- saves *.pxt file in Igor packed experiment format (*.pxp?)//  contains a single binary wave (for a single region sequence)//Contents://Proc  LoadSES(disp, hv, wf, en, cts)//Fct/T 	ReadSESB()//Fct/T 	ReadSESHdr(fpath, fnam)//Fct 	NextBlockPos(file, blocksize)//Fct/T 	ExtractNameB( filenam, option, numchar )//Proc 	ShowSESInfo(wvn, opt)//Fct/T 	SESInfoB( wv, opt )//Macro	AddSESTitleB( Sample, filnum, Polar, Elev, Epass, WkFct, hv )//Proc 	SummarizeLibrary()//Proc 	XPS_Style(xlabel, ylabel) 		: GraphStyle//Wndw 	FluxMonitor()					: Graph//Proc 	ShowLoadPanel()//Wndw 	Load_SES()									: Panel//Proc 	SelectLib(ctrlName) 							: ButtonControl//Proc 	SelectFile(ctrlName,popNum,popStr) 			: PopupMenuControl//Proc 	SetInputPop(ctrlName,popNum,popStr) 			: PopupMenuControl//Proc 	SetInput(ctrlName,varNum,varStr,varName) 	: SetVariableControl//Proc 	PlotSES(ctrlName) 							: ButtonControlmenu "Plot"	"-"	"Load Binary SES file",  LoadSESB()	"Append SES spectrum/`",  LoadSESB(root:SES:dscale, root:SES:escale, root:SES:hv_, root:SES:wfct, root:SES:angoffset1, root:SES:angoffset2, root:SES:nametyp, root:SES:namenum, 2)	"Add Graph title", AddSEStitleB()	"Show SES info", ShowSESinfo()	"Summarize Folder"	"ShowLoadPanel"endProc LoadSESb( cts,  escal, hv, wf, angoff1, angoff2,  namtyp, namnum, plotopt)//------------------------	variable plotopt, cts=NumVarOrDefault("root:SES:dscale",1)	variable angoff1=NumVarOrDefault("root:SES:angoffset1",NaN), angoff2=NumVarOrDefault("root:SES:angoffset2",NaN)	variable hv=NumVarOrDefault("root:SES:hv_",NaN), wf=NumVarOrDefault("root:SES:wfct",0)	variable namtyp=NumVarOrDefault("root:SES:nametyp",1), namnum=NumVarOrDefault("root:SES:namenum",1)	variable escal=NumVarOrDefault("root:SES:escale",1)		prompt cts, "Intensity option", popup "Counts;Cts/Sec;Cts/Flux;Flux only"		prompt plotopt, "Spectrum plot option", popup "Display;Append"		prompt angoff1, "Sample Angle(NaN for no offset):"		prompt angoff2, "Detector Angle Offset (NaN for no offset):"		prompt hv, "Photon Energy (eV) [NaN=leave as KE scale]"		prompt wf, "Work Function (eV) [4.1, SES, 4/97]:"		prompt namtyp, "Wave Naming (derived from filename):", popup "Prefix only;Remove . ;Convert . to _;Extension only"		prompt namnum, "Number of prefix characters", popup "all;2;3;4;5;6;7;8"		prompt escal, "Energy Scale interpretion", popup "KE;BE"	variable dum=1		silent 1; pauseupdate	String curr= GetDataFolder(1)	NewDataFolder/O/S root:SES		Variable/G angoffset1=angoff1, angoffset2=angoff2, hv_=hv, wfct=wf, nametyp=namtyp, namenum=namnum, dscale=cts, escale=escal	SetDataFolder curr//	string xlbl="Kinetic Energy (eV)", ylbl="Intensity (arb)"//Load from binary files	string base=ReadSESB(1-(plotopt<0))	if (strlen(base)==0)		abort 	endif	base=ExtractNameB( base, namtyp, namnum )   // need to put in loop for multiple regions	//Duplicate/O root:SES:infowav $(base+"_info")//	variable doimage=(disp==1)+(disp==2), dospectra=(disp==2)	string  dwn, xwn, ywn=base+"_y"	//duplicate/o root:SES:ANGLE $ywn		string titlestr, wlst, winnam, xlbl, ylbl	variable nx, ny=root:SES:nloop, nregion=root:SES:nregion	string eunit, yunit	variable ireg=0, eoff, yoff	DO		nx=root:SES:enpts[ireg]		if (nregion==1)			dwn=base		else			dwn=base+num2str(ireg)		endif		//if (cts<4)		string loadwv=GetIndexedObjName("root:SES:Load",1 ,0 )		//print loadwv, "///", dwn			duplicate/o $("root:SES:Load:"+loadwv) $("root:"+dwn)		//else		//	dwn+="flux"		//	duplicate/o $("root:SES:FLUX"+num2str(ireg)) $dwn		//endif				// (optional) rescale data to desired format		//----------------------------		ylbl="Counts"		if (cts>=2)			ylbl="cts/Sec"			$dwn/=(root:SES:dwell[ireg]*root:SES:nsweep[ireg])		endif		if (cts==3)				// flux has been integrated the same dwell & sweeps as data			ylbl="cts/flux"			$dwn/=$("root:SES:FLUX"+num2str(ireg))		endif				// check accuracy of nx(enpts) and ny(nloop) variable read from              variable nx0=DimSize( $dwn, 0), ny0=DimSize( $dwn, 1)             if (nx!=nx0)             	print "nx discrepancy: hdr=", nx, ",  data=", nx0             	nx=nx0             endif             if (ny0>0)            		 if (ny!=ny0)             		print "ny discrepancy: hdr=", ny, ",  data=", ny0             		ny=ny0             	endif             endif				// (optional) offset x-scale to BE using specified photon energy & work function		//---------------------------------		eoff=0;  	//eunit="KE"; 		variable mode=1		//1=KE, 2=BE		IF(mode==1)		xlbl="Kinetic Energy (eV)"		if ((escal==2)*(numtype(hv)==0))		//data stored as KE; only offset by  WorkFct			root:SES:estart+=-hv			// I prefer negative BEs			root:SES:eend+=-hv			//root:SES:estep*=-1			//eunit="BE"			xlbl="Binding Energy (eV)"			if (numtype(wf)==0)		// skip if NaN or INF				eoff=wf				root:SES:estart+=wf			// I prefer negative BEs				root:SES:eend+=wf			endif		else			eoff=0		endif		SetScale/P x root:SES:estart[ireg], root:SES:estep[ireg], "", $dwn		ELSE		xlbl="Kinetic Energy (eV)"		if (escal==2)					//data stored as BE; only offset by  WorkFct			//print "here"			root:SES:estart*=-1			// I prefer negative BEs			root:SES:estep*=-1			//eunit="BE"			xlbl="Binding Energy (eV)"			if (numtype(wf)==0)		// skip if NaN or INF				eoff=wf			endif		else			if (numtype(hv)==0)		// skip if NaN or INF				eoff=-(hv-wf)				//eunit="BE"			endif		endif		SetScale/P x root:SES:estart[ireg]+eoff, root:SES:estep[ireg], "", $dwn		ENDIF					// add to wavenote the offset		//Note/K $dwn		//Note $dwn, num2str(eoff)+",0,1,0,1,0,"+num2str(angoff1)				if (ny==1)							// single cycle: plot spectra only			redimension/N=(nx) $dwn			if (abs(plotopt)==1)				display $dwn				//y vs x option?				SES_XPS_StyleB( xlbl, ylbl)			else				DoWindow/F $WinName(0,1)				append $dwn			endif					else									// 2D data set			// (optional) offset y-scale to specified center value			//------------------------------------			if ((numtype(angoff2)==0)*(numtype(angoff2)==0))		// skip if NaN or INF				ylbl="Sample Angle (deg)"				yoff=angoff1-angoff2			else				ylbl="Analyzer Angle (deg)"				yoff=0			endif			//if (root:SES:kind==73)		//CIS			//	ylbl="Photon Energy (eV)"			//	yoff=0			//read in hv_start			//endif			//SetScale/P y root:SES:vstart-yoff, root:SES:vinc, "", $dwn						DoWindow/F $(dwn+"_")			if (V_flag==0)				titlestr=dwn+": "+num2str(nx)+"x"+num2str(ny)+"="+num2str(nx*ny)				display; appendimage $dwn				Textbox/N=title/F=0/A=MT/E titlestr				ModifyImage $dwn ctab= {*,*,YellowHot,0}				Label left ylbl				Label bottom xlbl				DoWindow/C $(dwn+"_")			endif		endif				ireg+=1	WHILE( ireg<nregion)		//print SESInfoB($base,0)	//DeleteWaveList( S_Wavenames )endFunction/T ReadSEShdr(fpath, fnam)//=================// read SES binary file header (actually ASCII text at the end)// saves values in root:SES folder variables	string fpath, fnam	variable debug=0			// programming flag	Variable file		NewDataFolder/O/S root:SES	//SetDataFolder root:SES:	String/G filnam=fnam, filpath=fpath		variable/G nregion=1		//variable/G kind	variable/G vstart=0, vinc=1, nloop=1	string/G skind	string/G sheader=""	string sline		//, sheader	Open/R file as filpath+filnam		FStatus file			if (debug)				print  S_Filename, ", numbytes=", V_logEOF			endif					// -- get number of regions		FReadLine file, sline		if (strsearch(sline, "[Info]",0)>=0)			FReadLine file, sline			//print StringByKey( "Number of Regions", sline[0,strlen(sline)-1], "=")			nregion=str2num( StringByKey( "Number of Regions", sline, "=" ) )  //[0,strlen(sline)-2]		else			nregion=1		endif				// ----- Read region info from [REGION #] blocks  -------	//, iEp, Epass, mode	//variable/G estart, eend, estep, dwell, nsweep	variable/G hv_	make/o/T/n=10 smode	make/o/n=10 iEp, Epass, mode, estart, eend, estep, dwell, nsweep, enpts	WAVE/T smode=smode	WAVE iEp=iEp, mode=mode, estart=estart, eend=eend, estep=estep, dwell=dwell, nsweep=nsweep, enpts=enpts				variable ii=0, val		DO			//-- find Region ii+1 start		 	variable jj=0			 DO				FReadLine file, sline				//if (strsearch(sline, "[Region "+num2str(ii+1)+"]",0)>=0)				if (strsearch(sline, "Location=",0)>=0)					//print "r", jj, sline					break				endif				//print "r", jj, sline				jj+=1			WHILE(jj<1000)						//-- load header lines into string			 jj=0			 DO				FReadLine file, sline				//print jj, sline[0,strlen(sline)-2]				sheader+=sline[0,strlen(sline)-2]+";"				jj+=1			WHILE(jj<24)			//print sheader						//-- extract variables from header keyword list			smode[ii]=StringByKey("Aquisition Mode", sheader, "=")			skind=StringByKey("Lens Mode", sheader, "=")			estart[ii]=str2num( StringByKey("Low Energy", sheader, "=") )			eend[ii]=str2num( StringByKey("High Energy", sheader, "=") )			estep[ii]=str2num( StringByKey("Energy Step", sheader, "=") )*sign(eend[ii]-estart[ii])			nsweep[ii]=str2num( StringByKey("Number of Sweeps", sheader, "=") )			dwell[ii]=str2num( StringByKey("Step Time", sheader, "=") )	//*nsweep[ii]			Epass[ii]=str2num( StringByKey("Pass Energy", sheader, "=") )			nloop=str2num( StringByKey("Number of Slices", sheader, "=") )			hv_=str2num( StringByKey("Excitation Energy", sheader, "=") )						enpts[ii]=round((eend[ii]-estart[ii])/estep[ii]+1)			//smode[ii]=StrFromList("Fixed;Swept;Stepped", mode[ii], ";")				if (debug)					print ii,": E: start, stop, step, Np, dwell, nsweep, mode, Ep=", estart[ii], eend[ii], estep[ii], enpts[ii], dwell[ii], nsweep[ii], smode[ii], Epass[ii]				endif			ii+=1		WHILE(ii<nregion)	Close file	string/G smode0=smode[0]	//abort		variable/G  iflux=0		//--- write info wave	if (nregion>1)		make/T/o/n=(18,nregion) infowav	else		make/T/o/n=(18) infowav	endif		//infowav={filnam, skind, smode,"hv","slits","Polar",num2str(Ep),"Slit#",num2tr(Estart)	//string/G smode0=smode[0]	ii=0	DO		infowav[0][ii]=filnam; infowav[1][ii]=skind; infowav[2][ii]=smode[ii]		infowav[3][ii]=num2str(hv_); infowav[4][ii]="R.P."; infowav[5][ii]="Polar"		infowav[6][ii]=num2str(Epass[ii]); infowav[7][ii]="Slit#"		infowav[8][ii]=num2str(Estart[ii]); infowav[9][ii]=num2str(Eend[ii]); infowav[10][ii]=num2str(Estep[ii])		infowav[11][ii]=num2str(1E-3*round(1E3*dwell[ii])); infowav[12][ii]=num2str(nsweep[ii])		infowav[13][ii]="Temp"		infowav[14][ii]=num2str(vstart); infowav[15][ii]=num2str(Vinc); infowav[16][ii]=num2str(nloop)		infowav[17][ii]=StrFromList("no;yes",iflux,";")		//num2str(iflux)		ii+=1	WHILE(ii<nregion)		SetDataFolder root:	return filnamEndFunction/T ReadSESb(idialog)//=================// read SES binary file// determines the number cycles (angle, space) and number of regions (per cycle)// saves values in root:SES folder variables	variable idialog	variable debug=0			// programming flag	//Variable file		SVAR filpath=root:SES:filpath, filnam=root:SES:filnam		NewDataFolder/O/S root:SES:Load	KillWaves/A/Z						// purge before loading new	//variable numLoadw=CountObjects("root:SES:Load", 1)	//string wvlst=GetIndexedObjName("root:SES:Load",1 ,0 )		string file_path=filpath	if (idialog>0)		variable file		Open/D/R/T="????"  file			//open file dialog only		filnam=S_filename		//print S_filename				// extract filpath from full file name		// and return short filename for wave renaming		string delim=":"                 //"\:"[cmpstr(IgorInfo(2), "Macintosh")==0]		variable nch=strlen(filnam), jj		jj=nch-1		DO 			if (cmpstr( filnam[jj], delim)==0)				break			endif			jj-=1		WHILE( jj>0)		file_path=filnam[0, jj]		filnam=filnam[jj+1, nch-1]		//print filpath, "// ", filnam	endif		LoadData/O/Q file_path+filnam		SetDataFolder root:	return filnamEndFunction NextBlockPos(file, blocksize)//=====================	variable file, blocksize	variable blocknum				FStatus file	return blocksize*ceil(V_filePos/blocksize) EndFunction/T ExtractNameB( filenam, option, numchar )//==================// return substring from DOS 8.3 filename acoording to option// 1=prefix only; 2=remove . ; 3=convert . to _; 4=extension only// 'numchar' specifies the # of prefix characters to use	string filenam	variable option, numchar	string prefix="", suffix=""	//variable nc=strlen(filenam)	variable ipd=strsearch(filenam,".",0)	if (ipd<0)					//no period found		ipd=strlen(filenam)		prefix=filenam		option=1	else		prefix=filenam[0, ipd-1]		suffix=filenam[ipd+1,strlen(filenam)-1]	endif	if (numchar<2)			// all		numchar=ipd	endif	prefix=prefix[0, numchar-1]	if (option==1)		suffix=""	endif	if (option==3)		prefix=prefix+"_"	endif	if (option==4)		prefix=""	endif	return prefix+suffixEndProc ShowSESinfo(wvn, opt)//-----------------	string wvn=root:SES:filnam+"_info"	variable opt	prompt wvn, "SES file info wave", popup, WaveList("*_info",";","")	prompt opt, "Display option", popup, "New Table;Append to topmost Table"	if (opt==1)		if (exists("root:SES:infonam")==0)			//make/N=18/T/O root:SES:infonam			List2Textw("filename,kind,mode,(hv),(R.P.),(Polar),Epass,Slit #,Ei,Ef,Estep,dwell,# sweep,T(K),Astart,Ainc,nloop,flux", ",", "root:SES:infonam")		endif		edit root:SES:infonam, $wvn	else		DoWindow/F $WinName(0, 2)		append $wvn	endifEndFunction/T SESinfoB( wv, opt )//====================//returns text string with specific file information//options:  0-return string only, 1-also print to history, 2-display table of all info	wave wv	variable opt	string base=NameOfWave(wv)	variable ptr=strsearch(base,"_",0)	if (ptr>0)		base=base[0,ptr-1]	endif	WAVE/T info=$(base+"_info")		string str=base+": "	str+="hv="+info[3]	str+="; resol="+info[4]	str+="; Ep="+info[6]	str+="; dwell="+info[12]+"x"+info[11]+" s"		//Energy scale	//WAVE xw=$(base+"_x"), raw=$(base+"_raw")	//WaveStats/Q xw	//variable incr=abs(round((xw[1]-xw[0])*1E4)/1E4)	str+="; rng=("+info[8]+","+info[9]+","+info[10]+")"	WaveStats/Q wv	//or just use info[14]	str+="; max="+num2str(V_max/1000)+""+info[18]		//Io fluctuation	//	WAVE mesh=$(base+"_mesh")	//	WaveStats/Q mesh	//	variable fluc=trunc(1000*(V_max-V_min)/V_avg)/10	//	str+="; ÆIo="+num2str(fluc)+"%"	if (opt==2)		DoWindow/F $(base+"_info")		if (V_Flag==0) 			if (exists("SES_info")==0)				make/o/T/N=15 SES_info				SES_info={"start","final","incr","range","resolution","hv","gate (ms)","#scans","Epass","pressure","CIS/CFS BE","mesh current","start beam curr.","end beam curr.","max counts (Hz)"}			endif			edit SES_info, info as base+"_info"		endif	else		if (opt==1)			print str		endif	endif	return strendProc AddSESTitleB( Sample, WinNam, filnum, Temp, hv, slits, Polr, Azim, Ep, WFct )//----------------	string Sample=StrVarOrDefault("root:SES:Sample0","A\\B1\\MB\\B2\\M")	string WinNam=StrVarOrDefault("root:SES:title0","TITLE"), filnum=StrVarOrDefault("root:SES:filnum0","000-009")	string Polr=num2str( NumVarOrDefault("root:SES:angoffset1",0)), Azim=StrVarOrDefault("root:SES:Azimuth","0")	variable Ep=root:SES:Epass[0], Wfct=NumVarOrDefault("root:SES:Wfct",4.35)	string hv=num2str(NumVarOrDefault("root:SES:hv_",30)), slits=StrVarOrDefault("root:SES:slit","10")	variable Temp=NumVarOrDefault("root:SES:TempK",30)	prompt WinNam, "Title/Window Name  (<>=no change)"	prompt slits, "Mono Slits or Res. Power"		PauseUpdate; Silent 1	String curr= GetDataFolder(1)	NewDataFolder/O/S root:SES		String/G Sample0=Sample, title0=WinNam, filnum0=filnum, Azimuth=Azim		//, hv_=hv	//, Polar=Polr, 		Variable/G Wfct0=Wfct, TempK=Temp, angoffset1=str2num(Polr), hv_=str2num(hv)		Epass[0]=Ep	SetDataFolder curr		//root:SES:sampleSav=sample		//root:SES:titleSav=WinNam		//root:SES:filnumSav=filnum		//root:SES:polarSav=polr		//root:SES:elevSav=elev		//root:SES:EpassSav=Epass		//root:SES:WFct=Wkfct		//root:SES:hvSav=hv		string titlestr="\\JC\\[0"+Sample+", "+WinNam+ ", ("+filnum+")"	titlestr+="\rhv="+hv+" eV ("+ slits +"), Polar="+Polr+", Azim="+Azim+","	titlestr+="Ep="+num2str(Ep)+", WF="+num2str(WFct)+", T="+num2str(Temp)+"K"	Textbox/K/N=title	Textbox/N=title/F=0/A=MT/E titlestr		if (strlen(WinNam)>0)		variable ic=StrSearch(WinNam, " ", 0)		if (ic>0)			WinNam[ic,ic]="_"		endif		DoWindow/C $WinNam		execute "DoWindow/C "+WinNam	endif	EndProc SummarizeFolder()//----------------// reads scan info from each file in a specified (dialog) SES data folder //    and prints the info to an Igor Notebook which than can then be used as is//    or imported (saved/pasted) into a spreadsheet	//PauseUpdate;	Silent 1		NewPath/O/Q/M="Select SES Data Folder" DataLibrary				//dialog selection	string pathnam, libnam, regionpath	Pathinfo DataLibrary	pathnam=S_path	//regionpath=pathnam+"REGIONS:"	variable nfolder=ItemsInList(pathnam, ":")            //FolderSep()) same on both Mac & PC	libnam=StrFromList(pathnam, nfolder-1, ":")         //FolderSep())	print pathnam, libnam		NewPath/O/Q DataLibrary pathnam	string filelst=IndexedFile( DataLibrary, -1, "????")		//"*.txt"	variable numfil=ItemsInList(filelst, ";")	print "# files=", numfil		//,  filelst		string Nbknam=libnam+"_"	NewNotebook/F=1/N=$Nbknam	variable j=72		//pts per inch	Notebook $Nbknam, fSize=9, margins={0,0,10.0*j }, backRGB=(65535,65534,49151), fStyle=1	Notebook $Nbknam, tabs={1*j,1.5*j,2*j, 2.5*j,3*j,3.5*j,4*j,4.5*j,5*j, 5.5*j, 6.0*j,6.6*j,7*j,7.5*j,8*j,8.5*j,9*j}	Notebook $Nbknam, text="filename\tkind\tmode\thv\tR.P.\tPolar\tEpass\tSlit#\tEi\tEf\tEstep\tdwell\tnswp\tT(K)\tAi\tAinc\tnloop\tflux"	Notebook $Nbknam, fStyle=0	string fnam, infostr	variable ii=0	DO		fnam=StrFromList(filelst, ii, ";")		ReadSESHdr( pathnam, fnam )		//print Textw2List(root:SES:infowav, "", 0, 18)		infostr="\r"+Textw2List(root:SES:infowav, "\t", 0, 17)		NoteBook $Nbknam, text=infostr			//SESInfoB()				ii+=1	WHILE(ii<numfil)EndProc SES_XPS_StyleB(xlabel, ylabel) : GraphStyle//------------------------	string xlabel="Binding Energy (eV)", ylabel="Intensity (kHz)"	PauseUpdate; Silent 1		// modifying window...	ModifyGraph/Z rgb[1]=(0,0,65535),rgb[2]=(3,52428,1),rgb[3]=(0,0,0)	ModifyGraph/Z tick=2	ModifyGraph/Z mirror=1	ModifyGraph/Z minor=1	ModifyGraph/Z sep=8	ModifyGraph/Z fSize=12	ModifyGraph/Z lblMargin(left)=7,lblMargin(bottom)=4	ModifyGraph/Z lblLatPos(bottom)=-1	Label/Z left ylabel	Label/Z bottom xlabelEndMacroWindow FluxMonitor() : Graph	PauseUpdate; Silent 1		// building window...	String fldrSav= GetDataFolder(1)	SetDataFolder root:SES:	Display /W=(594,57,942,244) FLUX0	AppendToGraph/R FLUX0	SetDataFolder fldrSav	ModifyGraph rgb(FLUX0#1)=(0,0,54272)	ModifyGraph tick(left)=2,tick(bottom)=2	ModifyGraph mirror(bottom)=1	ModifyGraph minor(left)=1,minor(bottom)=1	ModifyGraph sep(left)=8,sep(bottom)=10	ModifyGraph fSize(left)=12,fSize(bottom)=12	SetAxis/A/E=1 rightEndMacro//********  Load Panel ***************Proc ShowLoadPanel()//-----------------	DoWindow/F Load_SESb	if (V_flag==0)		NewDataFolder/O/S root:SES		string/G filpath, filnam, fileList		variable/G  filnum, numfiles, nregion, nloop		Make/O/N=(20) Estart, Eend, Estep, Epass		string/G skind, smode0		variable/G hv_, wfct, angoffset1, angoffset2, dscale, escale		SetDataFolder root:				Load_SESb()		endifEndWindow Load_SESb() : Panel	PauseUpdate; Silent 1		// building window...	NewPanel /W=(510,84,727,345)	ModifyPanel cbRGB=(65535,19662,42605)	SetDrawLayer UserBack	DrawText 76,18,"Data Folder"	SetDrawEnv fillfgc= (65495,2134,34028)	DrawRRect 6,39,205,140	SetDrawEnv fillpat= 5,fillfgc= (65495,2134,34028)	DrawRRect 7,144,203,221	Button button0,pos={12,1},size={30,16},proc=SelectLib,title="Set"	SetVariable setlib,pos={12,20},size={190,13},title=" ",fSize=10	SetVariable setlib,limits={-Inf,Inf,1},value= root:SES:filpath	PopupMenu popup_file,pos={14,44},size={134,19},proc=SelectFile,title="File"	PopupMenu popup_file,mode=8,popvalue="snap_008.pxt",value= #"root:SES:fileList\t\t"	SetVariable val_kind,pos={18,71},size={61,15},title=" "	SetVariable val_kind,limits={-Inf,Inf,1},value= root:SES:skind	SetVariable val_mode,pos={88,71},size={44,15},title=" "	SetVariable val_mode,limits={-Inf,Inf,1},value= root:SES:smode0	ValDisplay val_Ep,pos={142,71},size={50,15},title="Ep"	ValDisplay val_Ep,limits={0,0,0},barmisc={0,1000},value= #"root:SES:Epass[0]"	ValDisplay val_Estart,pos={14,92},size={55,15},title="Ei"	ValDisplay val_Estart,limits={0,0,0},barmisc={0,1000}	ValDisplay val_Estart,value= #"root:SES:Estart[0]"	ValDisplay val_Eend,pos={72,92},size={55,15},title="Ef"	ValDisplay val_Eend,limits={0,0,0},barmisc={0,1000},value= #"root:SES:Eend[0]"	ValDisplay val_Estep,pos={130,92},size={70,15},title="Einc"	ValDisplay val_Estep,limits={0,0,0},barmisc={0,1000},value= #"root:SES:Estep[0]"	ValDisplay val_Nloop,pos={29,116},size={66,15},title="# slice"	ValDisplay val_Nloop,limits={0,0,0},barmisc={0,1000},value= #"root:SES:nloop"	ValDisplay val_Nreg,pos={106,116},size={75,15},title="# region"	ValDisplay val_Nreg,limits={0,0,0},barmisc={0,1000},value= #"root:SES:nregion"	PopupMenu popup_Cts,pos={32,152},size={68,19},proc=SetInputPop	PopupMenu popup_Cts,mode=1,popvalue="Counts",value= #"\"Counts;Cts/Sec;Cts/Flux;Flux only\""	PopupMenu popup_Escale,pos={130,152},size={40,19},proc=SetInputPop	PopupMenu popup_Escale,mode=1,popvalue="KE",value= #"\"KE;BE\""	SetVariable set_hv,pos={23,178},size={75,15},proc=SetInput,title="hv"	SetVariable set_hv,limits={-Inf,Inf,1},value= root:SES:hv_	SetVariable set_wfct,pos={108,176},size={80,15},proc=SetInput,title="wfct"	SetVariable set_wfct,limits={-Inf,Inf,1},value= root:SES:wfct	SetVariable set_ang1,pos={16,197},size={85,15},proc=SetInput,title="Ang1"	SetVariable set_ang1,limits={-Inf,Inf,1},value= root:SES:angoffset1	SetVariable set_ang2,pos={107,197},size={85,15},proc=SetInput,title="Ang2"	SetVariable set_ang2,limits={-Inf,Inf,1},value= root:SES:angoffset2	Button StepMinus,pos={15,229},size={20,18},proc=StepFile,title="<<"	Button StepPlus,pos={40,229},size={20,18},proc=StepFile,title=">>"	Button PlotButton1,pos={73,228},size={55,20},proc=PlotSES,title="Display"	Button PlotButton2,pos={137,228},size={55,20},proc=PlotSES,title="Append"EndMacroProc SelectLib(ctrlName) : ButtonControl//-----------------------	String ctrlName	SetDataFolder root:SES:		NewPath/O/Q/M="Select SES Data Library" DataLibrary				//dialog selection	string/G filpath	string libnam, regionpath	Pathinfo DataLibrary	filpath=S_path	//regionpath=filpath+"REGIONS:"	//variable nfolder=ItemsInList(pathnam, FolderSep())	//libnam=StrFromList(pathnam, nfolder-1, FolderSep())	//print pathnam, regionpath, libnam		NewPath/O/Q DataLibrary filpath	fileList=IndexedFile( DataLibrary, -1, ".pxt")	numfiles=ItemsInList( fileList, ";")	PopupMenu popup_file value=root:SES:fileList		//#"root:SES:fileList"	//PopupMenu popup_file value=IndexedFile( DataLibrary, -1, "????")		SetDataFolder root:EndProc SelectFile(ctrlName,popNum,popStr) : PopupMenuControl//-----------------------------	String ctrlName	Variable popNum	String popStr	root:SES:filnam=popStr	root:SES:filnum=popNum	ReadSESHdr( root:SES:filpath, root:SES:filnam )EndProc StepFile(ctrlName) : ButtonControl//====================	String ctrlName	if (cmpstr(ctrlName,"StepMinus")==0)		root:SES:filnum=max(1, root:SES:filnum-1)	endif	if (cmpstr(ctrlName,"StepPlus")==0)		root:SES:filnum=min(root:SES:numfiles, root:SES:filnum+1)	endif	root:SES:filnam=StringFromList( root:SES:filnum-1, root:SES:fileList, ";")	PopupMenu popup_file mode=root:SES:filnum	ReadSESHdr( root:SES:filpath, root:SES:filnam )EndProc SetInputPop(ctrlName,popNum,popStr) : PopupMenuControl//---------------------------------	String ctrlName	Variable popNum	String popStr	if (cmpstr(ctrlName,"popup_cts")==0)		root:SES:dscale= popNum	endif	if (cmpstr(ctrlName,"popup_escale")==0)		root:SES:escale= popNum	endifEndProc SetInput(ctrlName,varNum,varStr,varName) : SetVariableControl//----------------------------------	String ctrlName	Variable varNum	String varStr	String varName		if (cmpstr(ctrlName,"set_hv")==0)		root:SES:hv_= varNum	endif	if (cmpstr(ctrlName,"set_wfct")==0)		root:SES:wfct= varNum	endif	if (cmpstr(ctrlName,"set_ang1")==0)		root:SES:angoffset1= varNum	endif	if (cmpstr(ctrlName,"set_ang2")==0)		root:SES:angoffset2= varNum	endifEndProc PlotSES(ctrlName) : ButtonControl//---------------------	String ctrlName		variable plotopt=-1							//negative means ReadSESB skips open dialog and uses current filename	if (cmpstr(ctrlName,"PlotButton2")==0)		plotopt=-2	endif	LoadSESB(root:SES:dscale, root:SES:escale, root:SES:hv_, root:SES:wfct, root:SES:angoffset1, root:SES:angoffset2, 1, 1, plotopt)End